var start;function tic(){start=Date.now()}function toc(){const millis=Date.now()-start;say(millis)}function fct_distance(pt_1,pt_2){let dist=Math.sqrt(Math.pow(pt_1[0]-pt_2[0],2)+Math.pow(pt_1[1]-pt_2[1],2));return dist}function create_matrix(m,n){let arr=new Array(m);for(var i=0;i<m;i++){arr[i]=new Array(n)}return arr}function getRandomArbitrary(min,max){return Math.random()*(max-min)+min}function sayVecAlert(arr){alert(arr.join("\n"))}function sayAlert(arr){alert(arr)}function say(truc){console.log(truc)}function getRelativeMousePosition(event,target){target=target||event.target;var rect=target.getBoundingClientRect();return{x:event.clientX-rect.left,y:event.clientY-rect.top}}function getNoPaddingNoBorderCanvasRelativeMousePosition(event,target){target=target||event.target;var pos=getRelativeMousePosition(event,target);pos.x=pos.x*target.width/target.clientWidth;pos.y=pos.y*target.height/target.clientHeight;return pos}function get_mouse_pos(e,target){const pos=getNoPaddingNoBorderCanvasRelativeMousePosition(e,target);let value_1=pos.x/info.canvas.width*2-1;let value_2=pos.y/info.canvas.height*-2+1;info.mouse=[value_1,value_2]}function sort_by_indice(arr){var indices=new Array(arr.length);for(var k=0;k<arr.length;++k)indices[k]=k;indices.sort(function(a,b){return arr[a]<arr[b]?-1:arr[a]>arr[b]?1:0});return indices}var info={canvas:0,context:0,program:0,param:{bkg:1,nb_point:0,primitiv_rgb:0,primitiv_alpha:0,speed:0,line_dist_max:0},mouse:0,attribut:{location:0,color:0},uniform:{in_mvp:0,point_size:5,is_point:false},limit:0};var mvp={projection:0,modelview:0,mvp:0};var vbo={pt_xy:0,pt_rgb:0,li_xy:0,li_rgb:0};var points_vbo_xy,points_vbo_rgb;var points={xy:0,rgb:0,nxy:0,size:0,draw:0,nb_point:0};var lines_vbo_xy,lines_vbo_rgb;var lines={xy:0,rgb:0,nb_point:0,draw:0};function shadering(){gl=info.context;const[vs,fs]=create_shader();program=init_program(gl,vs,fs);info.program=program;info.attribut.location=gl.getAttribLocation(program,"in_position");info.attribut.color=gl.getAttribLocation(program,"in_color");info.uniform.in_mvp=gl.getUniformLocation(program,"in_mvp");info.uniform.is_point=gl.getUniformLocation(program,"is_point");info.uniform.point_size=gl.getUniformLocation(program,"point_size")}function create_shader(){const shader_vertex=`#version 300 es

  in vec4 in_position;
  in vec4 in_color;
  out vec4 frag_color;
  uniform float point_size;

  void main(){
    gl_Position = in_position;
    gl_PointSize = point_size;

    frag_color = in_color;
  }
  `;const shader_fragment=`#version 300 es

  precision highp float;
  uniform bool is_point;
  in vec4 frag_color;
  out vec4 out_color;

  void main() {
    if(is_point){
      float r = 0.0, delta = 0.0, alpha = 1.0;
      vec2 cxy = 2.0 * gl_PointCoord - 1.0;
      r = dot(cxy, cxy);
      if (r > 1.0) {
        discard;
      }
    }
    out_color = frag_color;
  }
  `;return[shader_vertex,shader_fragment]}function load_shader(gl,type,source){const shader=gl.createShader(type);gl.shaderSource(shader,source);gl.compileShader(shader);if(!gl.getShaderParameter(shader,gl.COMPILE_STATUS)){alert("An error occurred compiling the shaders: "+gl.getShaderInfoLog(shader));gl.deleteShader(shader);return null}return shader}function init_program(gl,vs,fs){const vertexShader=load_shader(gl,gl.VERTEX_SHADER,vs);const fragmentShader=load_shader(gl,gl.FRAGMENT_SHADER,fs);const program=gl.createProgram();gl.attachShader(program,vertexShader);gl.attachShader(program,fragmentShader);gl.linkProgram(program);if(!gl.getProgramParameter(program,gl.LINK_STATUS)){alert("Unable to initialize the shader program: "+gl.getinfoLog(program));return null}return program}function init_points(nb_point){[XY,RGB,Nxy]=create_points(nb_point);points.xy=XY;points.rgb=RGB;points.nxy=Nxy;points.nb_point=nb_point;points.size=1;points.draw=gl.POINTS}function create_points(nb_point){let lim_x=info.limit[0];let lim_y=info.limit[1];let rgb=info.param.primitiv_rgb;let XY=[];for(let i=0;i<nb_point;i++){let X=getRandomArbitrary(-lim_x,lim_x);let Y=getRandomArbitrary(-lim_y,lim_y);XY.push([X,Y])}let RGB=[];for(let i=0;i<nb_point;i++){RGB.push([rgb,rgb,rgb,1])}let Nxy=[];for(let i=0;i<nb_point;i++){let Nx=getRandomArbitrary(-1,1);let Ny=getRandomArbitrary(-1,1);Nxy.push([Nx,Ny])}return[XY,RGB,Nxy]}function add_points(nb_point){[XY,RGB,Nxy]=create_points(nb_point);points.xy=points.xy.concat(XY);points.rgb=points.rgb.concat(RGB);points.nxy=points.nxy.concat(Nxy);points.nb_point=points.xy.length;points.draw=gl.POINTS}function add_points_xy(xy){[XY,RGB,Nxy]=create_points(1);XY[0][0]+=xy[0]+Nxy[0][0]*.001;XY[0][1]+=xy[1]+Nxy[0][1]*.001;RGB[0]=[0,0,1,1];points.xy=points.xy.concat(XY);points.rgb=points.rgb.concat(RGB);points.nxy=points.nxy.concat(Nxy);points.nb_point=points.xy.length;points.draw=gl.POINTS}function remove_points(nb_point){for(let i=0;i<nb_point;i++){points.xy.pop();points.nxy.pop();points.rgb.pop()}points.nb_point=points.xy.length}function move_points(){for(let i=0;i<points.xy.length;i++){dist=fct_distance(points.xy[i],info.mouse);if(dist<.2){points.xy[i][0]+=(.2-dist)*(points.xy[i][0]-info.mouse[0])*.2+points.nxy[i][0]*.001;points.xy[i][1]+=(.2-dist)*(points.xy[i][1]-info.mouse[1])*.2+points.nxy[i][1]*.001}else{points.xy[i][0]+=points.nxy[i][0]*info.param.speed;points.xy[i][1]+=points.nxy[i][1]*info.param.speed}check_areas_limit(i)}}function slider_points(){let nb_slider=info.param.nb_point;let diff=points.nb_point-nb_slider;if(diff>0){remove_points(diff)}else if(diff<0){add_points(-diff)}}function check_areas_limit(i){if(points.xy[i][0]<-info.limit[0]){points.xy[i][0]=-info.limit[0];points.nxy[i][0]=-points.nxy[i][0]}if(points.xy[i][0]>info.limit[0]){points.xy[i][0]=info.limit[0];points.nxy[i][0]=-points.nxy[i][0]}if(points.xy[i][1]<-info.limit[1]){points.xy[i][1]=-info.limit[1];points.nxy[i][1]=-points.nxy[i][1]}if(points.xy[i][1]>info.limit[1]){points.xy[i][1]=info.limit[1];points.nxy[i][1]=-points.nxy[i][1]}}function init_line(){lines.draw=gl.LINES}function collision(dist,i){let collid_thres=.01;var cpt_collision=0;if(dist<collid_thres){let Nx=getRandomArbitrary(-1,1);let Ny=getRandomArbitrary(-1,1);points.nxy[i]=[Nx,Ny];points.rgb[i]=[1,0,0,1];if(points.nb_point<200){cpt_collision++}}if(points.rgb[i][0]!=0){points.rgb[i][0]-=25e-5}}function move_line_all(){let XY=[];let RGB=[];for(let i=0;i<points.xy.length;i++){let dist_vec=new Array;for(let j=i+1;j<points.xy.length;j++){let dist=fct_distance(points.xy[i],points.xy[j]);collision(dist,i);collision(dist,j);dist_vec.push([dist,j])}create_line_all(XY,RGB,dist_vec,i)}for(let i=0;i<points.xy.length;i++){dist=fct_distance(points.xy[i],info.mouse);let alpha=-Math.log(dist/.2);if(dist<.2&&alpha>.1){XY.push(info.mouse);XY.push(points.xy[i]);RGB.push([0,0,1,alpha]);RGB.push([0,0,1,alpha])}}lines.xy=XY;lines.rgb=RGB;lines.nb_point=lines.xy.length}function create_line_all(XY,RGB,dist_vec,i){let rgb_alpha=info.param.primitiv_alpha;let rgb=info.param.primitiv_rgb;let dist_max=info.param.line_dist_max;for(let j=0;j<dist_vec.length;j++){let dist=dist_vec[j][0];let alpha=-Math.log(dist/dist_max)-.5;if(alpha>0&&dist<dist_max){XY.push(points.xy[i]);XY.push(points.xy[dist_vec[j][1]]);RGB.push([rgb,rgb,rgb,alpha]);RGB.push([rgb,rgb,rgb,alpha])}}}function move_line_knn(){let XY=[];let RGB=[];for(let i=0;i<points.xy.length;i++){let dist_vec=knn(i);create_line_knn(XY,RGB,dist_vec,i)}lines.xy=XY;lines.rgb=RGB;lines.nb_point=lines.xy.length}function create_line_knn(XY,RGB,dist_vec,i){let rgb_alpha=info.param.primitiv_alpha;let rgb=info.param.primitiv_rgb;let nb_link=info.param.nb_link;let dist_max=.5;if(dist_vec.length>=nb_link){for(let j=0;j<nb_link;j++){let dist=dist_vec[j][0];let alpha=-Math.log(dist/dist_max)-.5;if(alpha>0){XY.push(points.xy[i]);XY.push(points.xy[dist_vec[j][1]]);RGB.push([rgb,rgb,rgb,alpha]);RGB.push([rgb,rgb,rgb,alpha])}}}}function knn(i){let dist_vec=new Array;for(let j=0;j<points.xy.length;j++){if(i!=j){let dist=fct_distance(points.xy[i],points.xy[j]);dist_vec.push([dist,j]);collision(dist,i)}}dist_vec.sort();return dist_vec}function drawScene(){gl=info.context;compute_mvp();init_points(info.param.nb_point);init_line();[points_vbo_xy,points_vbo_rgb]=create_buffer();[lines_vbo_xy,lines_vbo_rgb]=create_buffer();create_object(points,points_vbo_xy,points_vbo_rgb);create_object(lines,lines_vbo_xy,lines_vbo_rgb);gl.useProgram(info.program);gl.uniformMatrix4fv(info.uniform.in_mvp,false,mvp.mvp);gl.uniform1f(info.uniform.point_size,info.param.point_size);function render(){gl.clearColor(info.param.bkg,info.param.bkg,info.param.bkg,1);gl.clearDepth(1);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);loop();requestAnimationFrame(render)}requestAnimationFrame(render)}function loop(){ui_update();move_points();move_line_all();gl.uniform1i(info.uniform.is_point,1);update_object(points,points_vbo_xy,points_vbo_rgb);draw_object(points,points_vbo_xy,points_vbo_rgb);gl.uniform1i(info.uniform.is_point,0);update_object(lines,lines_vbo_xy,lines_vbo_rgb);draw_object(lines,lines_vbo_xy,lines_vbo_rgb);compute_stats()}function compute_mvp(){gl=info.context;const fieldOfView=90*Math.PI/180;const aspect=gl.canvas.clientWidth/gl.canvas.clientHeight;const zNear=.1;const zFar=100;const proj_mat=glMatrix.mat4.create();glMatrix.mat4.ortho(proj_mat,-1,1,-1,1,zNear,zFar);const modelview_mat=glMatrix.mat4.create();mvp.projection=proj_mat;mvp.modelview=modelview_mat;mvp.mvp=modelview_mat}function draw_object(data,vbo_xy,vbo_rgb){gl=info.context;gl.bindBuffer(gl.ARRAY_BUFFER,vbo_xy);gl.vertexAttribPointer(info.attribut.location,2,gl.FLOAT,false,0,0);gl.enableVertexAttribArray(info.attribut.location);gl.bindBuffer(gl.ARRAY_BUFFER,vbo_rgb);gl.vertexAttribPointer(info.attribut.color,4,gl.FLOAT,false,0,0);gl.enableVertexAttribArray(info.attribut.color);gl.drawArrays(data.draw,0,data.nb_point)}function create_object(data,vbo_xy,vbo_rgb){gl=info.context;let XY=[];let RGB=[];for(let i=0;i<data.xy.length;i++){XY.push(data.xy[i][0]);XY.push(data.xy[i][1]);RGB.push(data.rgb[i][0]);RGB.push(data.rgb[i][1]);RGB.push(data.rgb[i][2]);RGB.push(data.rgb[i][3])}gl.bindBuffer(gl.ARRAY_BUFFER,vbo_xy);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(XY),gl.STREAM_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,vbo_rgb);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(RGB),gl.STREAM_DRAW)}function update_object(data,vbo_xy,vbo_rgb){gl=info.context;let XY=[];let RGB=[];for(let i=0;i<data.xy.length;i++){XY.push(data.xy[i][0]);XY.push(data.xy[i][1]);RGB.push(data.rgb[i][0]);RGB.push(data.rgb[i][1]);RGB.push(data.rgb[i][2]);RGB.push(data.rgb[i][3])}gl.bindBuffer(gl.ARRAY_BUFFER,vbo_xy);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(XY),gl.STREAM_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,vbo_rgb);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(RGB),gl.STREAM_DRAW)}function create_buffer(){vbo_xy=gl.createBuffer();vbo_rgb=gl.createBuffer();return[vbo_xy,vbo_rgb]}function compute_stats(){let P=1;let V=1*Math.pow(10,-20);let N=points.nb_point;let kb=1.38*Math.pow(10,-23);let T=P*V/(N*kb)}function ui_update(){var nb_points=document.getElementById("slider_points").value;var point_size=document.getElementById("slider_size").value;var speed=document.getElementById("slider_speed").value;var line_dist_max=document.getElementById("slider_line_dist_max").value;info.param.line_dist_max=line_dist_max;info.param.speed=speed;if(nb_points!=info.param.nb_point){info.param.nb_point=nb_points;slider_points()}if(point_size!=info.param.point_size){info.param.point_size=point_size;gl.uniform1f(info.uniform.point_size,point_size)}document.getElementById("cpt_points").value=info.param.nb_point;document.getElementById("cpt_size").value=info.param.point_size;document.getElementById("cpt_speed").value=info.param.speed;document.getElementById("cpt_line_dist_max").value=info.param.line_dist_max}main();function main(){create_context();shadering();drawScene()}function create_context(){const canvas=document.querySelector("#glcanvas");const gl=canvas.getContext("webgl2");if(!gl){alert("Unable to initialize WebGL. Your browser or machine may not support it.");return}resizeCanvasToDisplaySize(canvas);gl.viewport(0,0,gl.canvas.width,gl.canvas.height);info.context=gl;info.canvas=canvas;info.limit=[.8,.8];info.param.nb_point=50;info.param.bkg=1;info.param.nb_point=50;info.param.nb_link=3;info.param.primitiv_rgb=0;info.param.primitiv_alpha=.5;info.param.speed=.001;info.param.point_size=5;info.param.line_dist_max=.5;canvas.addEventListener("mousemove",event=>get_mouse_pos(event,canvas));document.getElementById("cpt_points").value=info.param.nb_point;document.getElementById("slider_points").value=info.param.nb_point;document.getElementById("cpt_size").value=info.param.point_size;document.getElementById("slider_size").value=info.param.point_size;document.getElementById("cpt_speed").value=info.param.speed;document.getElementById("slider_speed").value=info.param.speed;document.getElementById("cpt_line_dist_max").value=info.param.line_dist_max;document.getElementById("slider_line_dist_max").value=info.param.line_dist_max}function resizeCanvasToDisplaySize(canvas){const displayWidth=canvas.clientWidth;const displayHeight=canvas.clientHeight;const needResize=canvas.width!==displayWidth||canvas.height!==displayHeight;if(needResize){canvas.width=displayWidth;canvas.height=displayHeight}return needResize}function get_webgl_info(){say(gl.getParameter(gl.SHADING_LANGUAGE_VERSION));say(gl.getParameter(gl.VERSION))}